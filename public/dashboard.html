<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpindleFlow - Execution Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-indicator.disconnected {
            background: #ef4444;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-clear {
            background: #ef4444;
            color: white;
        }

        .btn-clear:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .execution-log {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 70vh;
            overflow-y: auto;
        }

        .execution-log h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .event {
            position: relative;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f3f4f6;
        }

        .event:last-child {
            border-bottom: none;
        }

        .event-marker {
            position: absolute;
            left: -26px;
            top: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .event-marker.workflow { background: #667eea; }
        .event-marker.agent { background: #10b981; }
        .event-marker.memory { background: #f59e0b; }
        .event-marker.error { background: #ef4444; }
        .event-marker.log { background: #6b7280; }

        .event-time {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 5px;
        }

        .event-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .event-details {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.6;
        }

        .event-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
            margin-top: 5px;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-error { background: #fee2e2; color: #991b1b; }

        .agents-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 70vh;
            overflow-y: auto;
        }

        .agents-panel h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .agent-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .agent-card.active {
            background: #eff6ff;
            border-left-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .agent-card.completed {
            opacity: 0.7;
        }

        .history-item {
            background: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .history-item-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .history-item-duration {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .tool-item {
            background: #f0fdf4;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #10b981;
        }

        .tool-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .tool-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .tool-count {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .agent-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-status {
            font-size: 12px;
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .event {
            animation: slideIn 0.3s ease;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üåÄ</span> SpindleFlow Dashboard
                <div class="status-indicator" id="statusIndicator"></div>
            </h1>
            <div class="controls">
                <button class="btn btn-clear" onclick="clearHistory()">Clear History</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Workflows</div>
                <div class="stat-value" id="totalWorkflows">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Agents Executed</div>
                <div class="stat-value" id="totalAgents">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Memory Queries</div>
                <div class="stat-value" id="memoryQueries">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Workflows</div>
                <div class="stat-value" id="activeWorkflows">0</div>
            </div>
        </div>

        <div class="main-content">
            <div class="execution-log">
                <h2>üìã Execution Timeline</h2>
                <div class="timeline" id="timeline">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <p>Waiting for workflow execution...</p>
                    </div>
                </div>
            </div>

            <div class="agents-panel">
                <h2>ü§ñ Active Agents</h2>
                <div id="agentsContainer">
                    <div class="empty-state">
                        <p>No active agents</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="agents-panel">
                <h2>üìä Agents Used History</h2>
                <div id="agentHistoryContainer">
                    <div class="empty-state">
                        <p>No agents executed yet</p>
                    </div>
                </div>
            </div>

            <div class="agents-panel">
                <h2>üîß MCP Tools Used</h2>
                <div id="toolsContainer">
                    <div class="empty-state">
                        <p>No tools invoked yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let stats = {
            workflows: 0,
            agents: 0,
            memoryQueries: 0,
            activeWorkflows: 0
        };
        let activeAgents = new Map();
        let agentHistory = [];
        let toolsUsed = new Map(); // toolName -> { count, lastUsed, agent }

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            ws = new WebSocket(`${protocol}//${host}`);

            ws.onopen = () => {
                console.log('Connected to SpindleFlow');
                document.getElementById('statusIndicator').classList.remove('disconnected');
            };

            ws.onclose = () => {
                console.log('Disconnected from SpindleFlow');
                document.getElementById('statusIndicator').classList.add('disconnected');
                setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'history') {
                    message.data.forEach(handleEvent);
                } else {
                    handleEvent(message);
                }
            };
        }

        function handleEvent(event) {
            switch (event.type) {
                case 'workflow_start':
                    stats.workflows++;
                    stats.activeWorkflows++;
                    addTimelineEvent(event, 'workflow', `Workflow Started: ${event.data.type}`, 
                        `Steps: ${event.data.totalSteps}`);
                    break;
                case 'workflow_end':
                    stats.activeWorkflows--;
                    addTimelineEvent(event, 'workflow', 'Workflow Completed', 
                        `Duration: ${(event.data.duration / 1000).toFixed(2)}s`);
                    break;
                case 'agent_start':
                    stats.agents++;
                    activeAgents.set(event.data.agentId, { ...event.data, progress: 0 });
                    addTimelineEvent(event, 'agent', `Agent Started: ${event.data.role}`, 
                        `ID: ${event.data.agentId} | Step ${event.data.stepNumber}/${event.data.totalSteps}`);
                    updateAgentsPanel();
                    break;
                case 'agent_complete':
                    const agent = activeAgents.get(event.data.agentId);
                    if (agent) {
                        agent.progress = 100;
                        agent.completed = true;
                        agent.duration = event.data.duration;
                        
                        // Add to history
                        agentHistory.push({
                            agentId: event.data.agentId,
                            role: agent.role,
                            duration: event.data.duration,
                            outputLength: event.data.outputLength,
                            timestamp: event.timestamp
                        });
                        
                        updateAgentsPanel();
                        updateAgentHistory();
                    }
                    addTimelineEvent(event, 'agent', `Agent Completed: ${event.data.agentId}`, 
                        `Duration: ${(event.data.duration / 1000).toFixed(2)}s | Output: ${formatBytes(event.data.outputLength)}`);
                    setTimeout(() => {
                        activeAgents.delete(event.data.agentId);
                        updateAgentsPanel();
                    }, 3000);
                    break;
                case 'agent_progress':
                    const progressAgent = activeAgents.get(event.data.agentId);
                    if (progressAgent) {
                        progressAgent.status = event.data.status;
                        progressAgent.progress = event.data.progress || progressAgent.progress;
                        updateAgentsPanel();
                    }
                    break;
                case 'memory_query':
                    stats.memoryQueries++;
                    addTimelineEvent(event, 'memory', `Memory Query: ${event.data.agentId}`, 
                        `Found ${event.data.count} memories (relevance: ${(event.data.topScore * 100).toFixed(1)}%)`);
                    break;
                case 'memory_store':
                    addTimelineEvent(event, 'memory', `Memory Stored: ${event.data.agentId}`, 
                        event.data.success ? 'Successfully stored' : 'Storage failed');
                    break;
                case 'error':
                    addTimelineEvent(event, 'error', `Error: ${event.data.agentId}`, 
                        event.data.error);
                    break;
                case 'tool_invocation':
                    const toolName = event.data.toolName;
                    if (!toolsUsed.has(toolName)) {
                        toolsUsed.set(toolName, {
                            count: 0,
                            lastUsed: event.timestamp,
                            agent: event.data.agentId,
                            type: event.data.type || 'unknown'
                        });
                    }
                    const toolData = toolsUsed.get(toolName);
                    toolData.count++;
                    toolData.lastUsed = event.timestamp;
                    toolData.agent = event.data.agentId;
                    
                    updateToolsPanel();
                    addTimelineEvent(event, 'log', `Tool Invoked: ${toolName}`, 
                        `Agent: ${event.data.agentId} | Type: ${event.data.type || 'MCP'}`);
                    break;
                case 'log':
                    addTimelineEvent(event, 'log', 'System Log', event.data.message);
                    break;
            }
            updateStats();
        }

        function addTimelineEvent(event, type, title, details) {
            const timeline = document.getElementById('timeline');
            const emptyState = timeline.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.innerHTML = `
                <div class="event-marker ${type}"></div>
                <div class="event-time">${new Date(event.timestamp).toLocaleTimeString()}</div>
                <div class="event-title">${title}</div>
                <div class="event-details">${details}</div>
            `;
            timeline.insertBefore(eventEl, timeline.firstChild);

            // Keep only last 50 events
            while (timeline.children.length > 50) {
                timeline.removeChild(timeline.lastChild);
            }
        }

        function updateStats() {
            document.getElementById('totalWorkflows').textContent = stats.workflows;
            document.getElementById('totalAgents').textContent = stats.agents;
            document.getElementById('memoryQueries').textContent = stats.memoryQueries;
            document.getElementById('activeWorkflows').textContent = stats.activeWorkflows;
        }

        function updateAgentsPanel() {
            const container = document.getElementById('agentsContainer');
            if (activeAgents.size === 0) {
                container.innerHTML = '<div class="empty-state"><p>No active agents</p></div>';
                return;
            }

            container.innerHTML = '';
            activeAgents.forEach((agent, id) => {
                const agentCard = document.createElement('div');
                agentCard.className = `agent-card ${agent.completed ? 'completed' : 'active'}`;
                agentCard.innerHTML = `
                    <div class="agent-name">
                        ${agent.completed ? '‚úì' : '‚öôÔ∏è'} ${agent.role}
                    </div>
                    <div class="agent-status">${agent.status || 'Processing'}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${agent.progress}%"></div>
                    </div>
                `;
                container.appendChild(agentCard);
            });
        }

        function updateAgentHistory() {
            const container = document.getElementById('agentHistoryContainer');
            if (agentHistory.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No agents executed yet</p></div>';
                return;
            }

            // Sort by timestamp (most recent first)
            const sortedHistory = [...agentHistory].sort((a, b) => b.timestamp - a.timestamp);
            
            container.innerHTML = '';
            sortedHistory.slice(0, 10).forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-info">
                        <div class="history-item-name">${item.role}</div>
                        <div class="history-item-meta">
                            ${new Date(item.timestamp).toLocaleTimeString()} ‚Ä¢ 
                            Output: ${formatBytes(item.outputLength)}
                        </div>
                    </div>
                    <div class="history-item-duration">
                        ${(item.duration / 1000).toFixed(2)}s
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }

        function updateToolsPanel() {
            const container = document.getElementById('toolsContainer');
            if (toolsUsed.size === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tools invoked yet</p></div>';
                return;
            }

            // Convert to array and sort by count (most used first)
            const sortedTools = Array.from(toolsUsed.entries())
                .sort((a, b) => b[1].count - a[1].count);
            
            container.innerHTML = '';
            sortedTools.forEach(([toolName, data]) => {
                const toolItem = document.createElement('div');
                toolItem.className = 'tool-item';
                toolItem.innerHTML = `
                    <div class="tool-name">
                        üîß ${toolName}
                        <span class="tool-count">${data.count}x</span>
                    </div>
                    <div class="tool-meta">
                        Last used: ${new Date(data.lastUsed).toLocaleTimeString()} ‚Ä¢ 
                        By: ${data.agent} ‚Ä¢ 
                        Type: ${data.type}
                    </div>
                `;
                container.appendChild(toolItem);
            });
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(2) + 'MB';
        }

        function clearHistory() {
            fetch('/api/clear', { method: 'POST' })
                .then(() => {
                    document.getElementById('timeline').innerHTML = '<div class="empty-state"><p>History cleared</p></div>';
                    stats = { workflows: 0, agents: 0, memoryQueries: 0, activeWorkflows: 0 };
                    agentHistory = [];
                    toolsUsed.clear();
                    updateStats();
                    updateAgentHistory();
                    updateToolsPanel();
                });
        }

        // Initialize
        connect();
    </script>
</body>
</html>
